---
- hosts: haproxy-1
  become: true
  vars_files:
    - /etc/ansible/haproxy.yml
  tasks:
    - name: Installation of keepalived
      apt:
        name: keepalived
        state: present
        update_cache: true

    - name: Configure keepalived
      copy:
        dest: /etc/keepalived/keepalived.conf
        owner: root
        group: root
        mode: '0644'
        content: |
          vrrp_instance haproxy-vip {
            state MASTER
            priority 100
            interface eth0
            virtual_router_id 60
            advert_int 1

            authentication {
              auth_type PASS
              auth_pass 1234
            }

            unicast_src_ip {{ haproxy_1 }}
            unicast_peer {
              {{ haproxy_2 }}
            }

            virtual_ipaddress {
              10.0.1.19/24
            }
          }

    - name: Restart keepalived
      service:
        name: keepalived
        state: restarted
        enabled: true

- hosts: haproxy-2
  become: true
  vars_files:
    - /etc/ansible/haproxy.yml
  tasks:
    - name: Installation of keepalived
      apt:
        name: keepalived
        state: present
        update_cache: true

    - name: Configure keepalived
      copy:
        dest: /etc/keepalived/keepalived.conf
        owner: root
        group: root
        mode: '0644'
        content: |
          vrrp_instance haproxy-vip {
            state BACKUP
            priority 99
            interface eth0
            virtual_router_id 60
            advert_int 1

            authentication {
              auth_type PASS
              auth_pass 1234
            }

            unicast_src_ip {{ haproxy_2 }}
            unicast_peer {
              {{ haproxy_1 }}
            }

            virtual_ipaddress {
              10.0.1.19/24
            }
          }

    - name: Restart keepalived
      service:
        name: keepalived
        state: restarted
        enabled: true
