---
- name: Initialize first Kubernetes main master
  hosts: main-master
  become: true
  vars_files:
    - /home/ubuntu/ha-ip.yml

  tasks:

  # ---------------- SYSTEM PREREQUISITES ----------------

  - name: Disable swap immediately
    command: swapoff -a
    when: ansible_swaptotal_mb > 0

  - name: Disable swap permanently
    replace:
      path: /etc/fstab
      regexp: '^([^#].*swap.*)$'
      replace: '# \1'

  - name: Load br_netfilter module
    modprobe:
      name: br_netfilter
      state: present

  - name: Apply Kubernetes sysctl settings
    sysctl:
      name: "{{ item.key }}"
      value: "{{ item.value }}"
      reload: yes
      state: present
    loop:
      - { key: "net.bridge.bridge-nf-call-iptables", value: "1" }
      - { key: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
      - { key: "net.ipv4.ip_forward", value: "1" }

  # ---------------- KUBEADM INIT ----------------

  - name: Initialize Kubernetes Master
    command: >
      kubeadm init
      --control-plane-endpoint={{ haproxy_1 }}:6443
      --apiserver-advertise-address={{ ansible_host }}
      --apiserver-cert-extra-sans={{ haproxy_1 }}
      --pod-network-cidr=10.244.0.0/16
      --cri-socket=/run/cri-dockerd.sock
      --upload-certs
    register: kubeadm_init
    args:
      creates: /etc/kubernetes/admin.conf

  - name: Save kubeadm init output to control node
    local_action:
      copy content="{{ kubeadm_init.stdout }}" dest="/tmp/kubeadm-init.out"
    when: kubeadm_init.changed

  # ---------------- KUBECONFIG ----------------

  - name: Create kubeconfig directory
    file:
      path: /home/ubuntu/.kube
      state: directory
      owner: ubuntu
      group: ubuntu
      mode: 0700

  - name: Copy admin kubeconfig
    copy:
      src: /etc/kubernetes/admin.conf
      dest: /home/ubuntu/.kube/config
      remote_src: yes
      owner: ubuntu
      group: ubuntu
      mode: 0600

  # ---------------- API HEALTH CHECK ----------------

  - name: Wait for API server to respond
    uri:
      url: https://127.0.0.1:6443/healthz
      validate_certs: no
      status_code: 200
    register: api_health
    retries: 10
    delay: 15
    until: api_health.status == 200

  # ---------------- NETWORK (CNI) ----------------

  - name: Apply Flannel CNI if not already present
    command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
    environment:
      KUBECONFIG: /etc/kubernetes/admin.conf

  # ---------------- CONTROL PLANE CHECK ----------------

  - name: Wait for control plane pods
    command: kubectl get pods -n kube-system
    environment:
      KUBECONFIG: /etc/kubernetes/admin.conf
    register: cp_status
    retries: 10
    delay: 20
    until: "'Running' in cp_status.stdout"

  # ---------------- DNS VERIFICATION ----------------

  - name: Verify CoreDNS pods
    command: kubectl get pods -n kube-system -l k8s-app=kube-dns
    environment:
      KUBECONFIG: /etc/kubernetes/admin.conf
    register: dns_status

  - debug:
      var: dns_status.stdout

  # ---------------- JOIN TOKEN ----------------

  - name: Generate join command
    command: kubeadm token create --print-join-command
    register: join_cmd

  - name: Display join command
    debug:
      msg: "{{ join_cmd.stdout }}"